name: Build Im

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: true
        default: 'false'
        type: choice
        options:
          - true
          - false
  schedule:
    - cron: "0 0 1,16 * *"

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    # ----------------------
    # Checkout
    # ----------------------
    - name: Checkout
      uses: actions/checkout@main

    # ----------------------
    # Initialize environment (SAFE)
    # ----------------------
    - name: Initialize environment
      env:
        DEBIAN_FRONTEND: noninteractive
        APT_LISTCHANGES_FRONTEND: none
      run: |
        set -e

        # 禁止所有 service restart（CI 必杀技）
        sudo tee /usr/sbin/policy-rc.d >/dev/null << 'EOF'
        #!/bin/sh
        exit 0
        EOF
        sudo chmod +x /usr/sbin/policy-rc.d

        # 禁用 needrestart 交互
        sudo mkdir -p /etc/needrestart/conf.d
        echo '$nrconf{restart} = "l";' | sudo tee /etc/needrestart/conf.d/99-ci.conf

        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler \
          ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev \
          gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
          libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
          libncurses-dev libpython3-dev libreadline-dev libssl-dev libtool \
          libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano ninja-build \
          p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply \
          python3-docutils python3-pyelftools qemu-utils re2c rsync scons \
          squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim \
          wget xmlto xxd zlib1g-dev zstd libfuse-dev fuse

        # Go 1.25+
        wget -q https://go.dev/dl/go1.25.3.linux-amd64.tar.gz
        sudo rm -rf /usr/local/go
        sudo tar -C /usr/local -xzf go1.25.3.linux-amd64.tar.gz
        echo "/usr/local/go/bin" >> $GITHUB_PATH
        go version

        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        ccache -M 10G

    # ----------------------
    # Clone OpenWrt
    # ----------------------
    - name: Clone OpenWrt
      working-directory: /workdir
      run: |
        git clone $REPO_URL -b $REPO_BRANCH --depth=1 openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        echo "FILE_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

    # ----------------------
    # Cache dl
    # ----------------------
    - name: Cache dl
      uses: actions/cache@v4
      with:
        path: openwrt/dl
        key: dl-${{ env.REPO_BRANCH }}-${{ github.run_id }}
        restore-keys: |
          dl-${{ env.REPO_BRANCH }}-

    # ----------------------
    # Cache ccache
    # ----------------------
    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ env.REPO_BRANCH }}-${{ github.run_id }}
        restore-keys: |
          ccache-${{ env.REPO_BRANCH }}-

    # ----------------------
    # Feeds & DIY
    # ----------------------
    - name: Update feeds
      run: |
        chmod +x armsr/armv8/diy/diy.sh
        cd openwrt
        ./scripts/feeds update -a
        $GITHUB_WORKSPACE/armsr/armv8/diy/diy.sh
        ./scripts/feeds install -a

    # ----------------------
    # Load N1 config
    # ----------------------
    - name: Load N1 config
      run: |
        rm -rf openwrt/files openwrt/.config
        mv armsr/armv8/N1/files armsr/armv8/N1/.config openwrt/

    # ----------------------
    # SSH (optional)
    # ----------------------
    - name: SSH connect
      uses: P3TERX/ssh2actions@main
      if: github.event.inputs.ssh == 'true'

    # ----------------------
    # Download packages
    # ----------------------
    - name: Download packages
      working-directory: openwrt
      run: |
        make defconfig
        make download -j$(( $(nproc) * 2 ))
        find dl -size -1k -delete

    # ----------------------
    # Compile
    # ----------------------
    - name: Compile firmware
      run: |
        cd openwrt
        make -j$(( $(nproc) + 1 )) || make -j1 V=s

    # ----------------------
    # Pack N1
    # ----------------------
    - name: Package N1
      uses: unifreq/openwrt_packit@master
      env:
        OPENWRT_ARMVIRT: openwrt/bin/targets/armsr/armv8/*rootfs.tar.gz
        KERNEL_REPO_URL: breakingbadboy/OpenWrt
        KERNEL_VERSION_NAME: 6.6.y_6.12.y
        PACKAGE_SOC: diy
        GZIP_IMGS: .xz
        SCRIPT_DIY_PATH: armsr/armv8/N1/mk_s905d_n1.sh
        WHOAMI: nantayo

    # ----------------------
    # Release
    # ----------------------
    - name: Upload firmware
      uses: softprops/action-gh-release@master
      with:
        tag_name: OpenWrt_${{ env.FILE_DATE }}
        files: ${{ env.PACKAGED_OUTPUTPATH }}/*.img.xz
        body: |
          首次使用建议全新刷写
          IP: 192.168.2.2
          用户: root
          密码: password
